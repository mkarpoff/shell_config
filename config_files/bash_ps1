#!/bin/bash
# Prompt function because PROMPT_COMMAND is awesome

function set_powerline_prompt() {
	RA=' '

	BLKF="\\[$(tput setaf  0)\\]"
	BLKB="\\[$(tput setab  0)\\]"
	GREF="\\[$(tput setaf  2)\\]"
	GREB="\\[$(tput setab  2)\\]"
	YELF="\\[$(tput setaf  3)\\]"
	YELB="\\[$(tput setab  3)\\]"
	PRPF="\\[$(tput setaf 13)\\]"
	PRPB="\\[$(tput setab 13)\\]"
	BLUF="\\[$(tput setaf  4)\\]"
	BLUB="\\[$(tput setab  4)\\]"

	# Display Username
	usrin="${GREB}${BLKF} \\h  ${GREF}"

	# GIT STUFF
	if [ -d .git ] || git rev-parse --get-dir > /dev/null 2>&1
	then
		if git update-index -q --refresh 2>/dev/null; git diff-index --quiet\
			--cached HEAD --ignore-submodules -- 2>/dev/null && git diff-files\
			--quiet --ignore-submodules 2>/dev/null
		then
			dirty=" "
		else
			dirty="*"
		fi
		_branch=$(git symbolic-ref HEAD 2>/dev/null)
		_branch=${_branch#refs/heads/} # apparently faster than sed
		if [[ -n $_branch ]]; then
			branch="${YELB}${RA}${BLKF} ${_branch}${REDF}${dirty} ${YELF}"
		fi
	else
		branch=""
	fi

	# Virtual Env stuff
	if [[ $VIRTUAL_ENV != "" ]]; then
		_venv=${VIRTUAL_ENV##*/}
		venv="${PRPB}${RA}${BLKF} ${_venv}  ${PRPF}"
	else
		venv=""
	fi

	path="${BLUB}${RA}${BLKF} \\w  ${BLUF}"

	ps1a="${usrin}${branch}${venv}${path} ${BLKB}${RA} "
	ps1b="${BLKB}${GREF}${RA}\\[$(tput sgr0)\\]"
	PS1="${ps1a}\\r\\n${ps1b}"
	PS2="${ps1b}"
	export PS1
	export PS2
}

function set_normal_prompt() {
	REDF="\\[$(tput setaf  1)\\]"
	YELF="\\[$(tput setaf  3)\\]"
	GREF="\\[$(tput setaf 10)\\]"
	BLUF="\\[$(tput setaf 12)\\]"
	PURF="\\[$(tput setaf 13)\\]"

	# Display Username
	usrin="${REDF}{${GREF}\\h${REDF}}"

	# GIT STUFF
	if [ -d .git ] || git rev-parse --get-dir > /dev/null 2>&1
	then
		if git update-index -q --refresh 2>/dev/null; git diff-index --quiet\
			--cached HEAD --ignore-submodules -- 2>/dev/null && git diff-files\
			--quiet --ignore-submodules 2>/dev/null
		then
			dirty=""
		else
			dirty="*"
		fi
		_branch=$(git symbolic-ref HEAD 2>/dev/null)
		_branch=${_branch#refs/heads/} # apparently faster than sed
		branch="" # need this to clear it when we leave a repo
		if [[ -n $_branch ]]; then
			branch="${REDF}[${YELF}${_branch}${REDF}${dirty}]"
		fi
	else
		branch=""
	fi
	# Virtual Env stuff
	if [[ $VIRTUAL_ENV != "" ]]; then
		_venv=${VIRTUAL_ENV##*/}
		venv="${REDF}(${PURF}${_venv}${REDF})"
	else
		venv=""
	fi

	path="${REDF}<${BLUF}\\w ${REDF}>"

	ps1a="${REDF}┌─${usrin}${branch}${venv}${path}"
	ps1b="${REDF}└─>\\[$(tput sgr0)\\]"
	PS1="${ps1a}\\r\\n${ps1b}"
	PS2="$ps1b"
	export PS1
	export PS2
}

has_powerline() {
	fc-list | grep -i "Powerline.ttf" >/dev/null
}

function set_prompt() {
	if has_powerline; then
		use_powerline=$(( 1 ))
	else 
		use_powerline=$(( 0 ))
	fi
	if (( use_powerline )); then
		set_powerline_prompt
	else
		set_normal_prompt
	fi
}

export PROMPT_COMMAND=set_prompt
